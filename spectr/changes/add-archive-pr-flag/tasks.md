# Tasks: Implement `--pr` Flag for Archive Command

## 1. Git and PR Infrastructure

- [ ] 1.1 Determine if `add-propose-command` has implemented git/PR logic (check for `internal/git/` or `internal/propose/` with reusable code)
- [ ] 1.2 If reusable git/PR package exists, identify and document the API for reuse
- [ ] 1.3 If no reusable package exists, create `internal/git/` package directory
- [ ] 1.4 Implement git platform detection from remote URL (supports GitHub, GitLab, Gitea/Forgejo)
- [ ] 1.5 Implement git operations module (branch creation, staging, commit, push)
- [ ] 1.6 Implement PR CLI tool selection and invocation logic (gh, glab, tea)
- [ ] 1.7 Implement PR URL extraction from CLI tool output
- [ ] 1.8 Add comprehensive error handling for git and PR operations

## 2. Command Flag Integration

- [ ] 2.1 Add `PR bool` field to `ArchiveCmd` struct in `cmd/archive.go`
- [ ] 2.2 Add flag definition with name `"pr"` and help text: "Create pull request after successful archive"
- [ ] 2.3 Pass `PR` flag value to `Archiver.NewArchiver()` or add to existing archiver configuration
- [ ] 2.4 Update `ArchiveCmd.Run()` to pass PR flag to archiver

## 3. Archiver PR Workflow Implementation

- [ ] 3.1 Add `pr bool` field to `Archiver` struct in `internal/archive/archiver.go`
- [ ] 3.2 Create `createPR()` method on Archiver that orchestrates PR creation workflow
- [ ] 3.3 Implement PR workflow activation at end of `Archive()` method (only after successful archive)
- [ ] 3.4 Implement git repository validation (check for .git directory)
- [ ] 3.5 Implement origin remote validation (check `git config --get remote.origin.url`)
- [ ] 3.6 Implement branch creation with naming convention `archive-<change-id>`
- [ ] 3.7 Implement file staging (archived directory + updated specs)
- [ ] 3.8 Implement commit message generation with operation summary
- [ ] 3.9 Implement branch push to origin
- [ ] 3.10 Implement platform detection and PR CLI invocation
- [ ] 3.11 Implement PR URL display after successful creation
- [ ] 3.12 Ensure archive is complete and valid even if PR creation fails

## 4. PR Content Generation

- [ ] 4.1 Create PR title generator: "Archive: <change-id>"
- [ ] 4.2 Create PR body template builder
- [ ] 4.3 Implement archive summary section (change ID, location)
- [ ] 4.4 Implement spec updates section with operation counts and capability list
- [ ] 4.5 Implement logic to detect `--skip-specs` and adjust PR body accordingly
- [ ] 4.6 Implement review notes section with guidance
- [ ] 4.7 Add footer attribution: "Generated by `spectr archive --pr`"

## 5. Commit Message Generation

- [ ] 5.1 Create commit message builder that formats "Archive: <change-id>" title
- [ ] 5.2 Add archive location to commit body
- [ ] 5.3 Add spec operation counts to commit body (use archiver's operation counts)
- [ ] 5.4 Handle case when `--skip-specs` is used (omit spec operations section)
- [ ] 5.5 Add Change-Id trailer to commit message
- [ ] 5.6 Test commit message with heredoc or file-based input to handle multiline

## 6. Error Handling and Validation

- [ ] 6.1 Validate git repository exists before attempting git operations
- [ ] 6.2 Validate origin remote is configured
- [ ] 6.3 Validate PR CLI tool is installed (gh/glab/tea based on platform detection)
- [ ] 6.4 Handle branch name conflicts (branch already exists)
- [ ] 6.5 Handle commit failures with descriptive error messages
- [ ] 6.6 Handle push failures (network errors, authentication)
- [ ] 6.7 Handle PR creation failures (API errors, permissions)
- [ ] 6.8 Ensure all error messages guide user on how to recover manually
- [ ] 6.9 Log or display clear state after each failed step

## 7. Testing

- [ ] 7.1 Create unit tests for git platform detection
- [ ] 7.2 Create unit tests for branch naming logic
- [ ] 7.3 Create unit tests for commit message generation
- [ ] 7.4 Create unit tests for PR body generation
- [ ] 7.5 Create integration test for archive + PR workflow (mock git operations)
- [ ] 7.6 Test error cases: no git repo, no remote, tool not installed
- [ ] 7.7 Test flag combinations: `--pr --yes`, `--pr --skip-specs`, `--pr --interactive`
- [ ] 7.8 Test with GitHub, GitLab, and Gitea remote URL patterns
- [ ] 7.9 Test archive failure prevents PR creation
- [ ] 7.10 Create `internal/archive/pr_test.go` or similar for PR-specific tests

## 8. Documentation and Help Text

- [ ] 8.1 Update `cmd/archive.go` help text to document `--pr` flag
- [ ] 8.2 Add usage examples to command help showing `--pr` combinations
- [ ] 8.3 Document git and PR CLI tool dependencies in error messages
- [ ] 8.4 Verify help output with `spectr archive --help` shows clear flag description

## 9. Integration and End-to-End Testing

- [ ] 9.1 Test complete workflow: archive a real change with `--pr` flag
- [ ] 9.2 Verify branch is created with correct name
- [ ] 9.3 Verify commit includes archived directory and updated specs
- [ ] 9.4 Verify commit message format is correct
- [ ] 9.5 Verify PR is created on the correct platform
- [ ] 9.6 Verify PR title and body match expected format
- [ ] 9.7 Test on Linux, macOS, and Windows (or use CI)
- [ ] 9.8 Test with different git hosting platforms (GitHub, GitLab, Gitea)

## 10. Polish and Code Quality

- [ ] 10.1 Run `golangci-lint` and fix any linting issues
- [ ] 10.2 Ensure all exported functions have doc comments
- [ ] 10.3 Add inline comments for complex logic (platform detection, error handling)
- [ ] 10.4 Verify error messages are consistent and helpful
- [ ] 10.5 Check for code duplication with propose command (extract to shared package if needed)
- [ ] 10.6 Ensure proper error wrapping with context using `fmt.Errorf`

---

**Completion Criteria**:
- All tests pass
- No linting errors
- `spectr archive <change-id> --pr` successfully creates a PR for an archived change
- All error paths are tested and provide clear guidance
- PR content (title, body, commit message) matches specification
- Works with GitHub, GitLab, and Gitea platforms
- Archive completes successfully even if PR creation fails
